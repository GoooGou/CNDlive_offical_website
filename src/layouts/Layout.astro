---
// src/layouts/Layout.astro
import { ClientRouter } from 'astro:transitions';
import Footer from '@/components/Footer.astro';
import '@/styles/global.css';
import Navbar from '@/components/navbar/Navbar.jsx';
import FloatingTools from '@/components/ui/FloatingTools.jsx';
import type { ACTION_ERROR_CODES } from 'astro:actions';
// âœ… å¼•å…¥å­—ä½“æ–‡ä»¶ (å®ƒä»¬ä¼šè‡ªåŠ¨æ³¨å…¥ CSS @font-face)
import '@fontsource-variable/montserrat';

// --- 1. å®šä¹‰ CNDLive å®˜æ–¹ SEO ä¿¡æ¯ (é»˜è®¤å€¼) ---
const SITE_TITLE =
  'CNDLive - Professional Video Streaming Solutions | Encoders & Decoders';
const SITE_DESCRIPTION =
  'CNDLive provides professional video IP transmission solutions. We offer 4K HDMI/SDI video encoders, decoders, NDI converters, and 4G/5G bonding routers for broadcast and live streaming.';
const SITE_KEYWORDS =
  'Video Encoder, Video Decoder, 4K Streaming, NDI Converter, SRT Encoder, RTMP, Bonding Encoder, 4G Bonding, Live Broadcasting, CNDLive';

const isHomepage = Astro.url.pathname === '/';
const canonicalURL = new URL(Astro.url.pathname, Astro.site);

interface Props {
  title?: string;
  description?: string;
  image?: string;
  schema?: object;
}

const {
  // ğŸ”¥ å¦‚æœé¡µé¢æ²¡ä¼  titleï¼Œå°±ç”¨ CNDLive å®˜æ–¹æ ‡é¢˜
  title = SITE_TITLE,
  // ğŸ”¥ å¦‚æœé¡µé¢æ²¡ä¼  descriptionï¼Œå°±ç”¨å®˜æ–¹æè¿°
  description = SITE_DESCRIPTION,
  image = '/images/default-og.png',
  schema,
} = Astro.props;

const socialImageURL = new URL(image, Astro.site);

// å…¨å±€ Organization Schema
const orgSchema = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: 'CNDLive',
  url: 'https://cndlive.com',
  logo: 'https://cndlive.com/logo.svg',
  sameAs: [
    'https://www.facebook.com/cndlive',
    'https://www.linkedin.com/company/cndlive',
    'https://www.youtube.com/@cndlive',
  ],
  contactPoint: {
    '@type': 'ContactPoint',
    telephone: '+86-0755-26888079',
    contactType: 'customer support',
  },
};
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    {/* --- æ ¸å¿ƒ SEO --- */}
    <title>{title}</title>
    <meta name="description" content={description} />
    {/* ğŸ”¥ æ–°å¢ï¼šå…³é”®è¯æ ‡ç­¾ */}
    <meta name="keywords" content={SITE_KEYWORDS} />

    {/* å¯ç”¨è§†å›¾è¿‡æ¸¡ */}
    <ClientRouter />

    {/* --- SEO Canonical --- */}
    <link rel="canonical" href={canonicalURL} />

    {/* --- Open Graph (Facebook, LinkedIn) --- */}
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={socialImageURL} />
    <meta property="og:site_name" content="CNDLive" />

    {/* --- Twitter (X) --- */}
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:domain" content={Astro.site?.host} />
    <meta name="twitter:url" content={Astro.url} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={socialImageURL} />

    {/* --- ç»“æ„åŒ–æ•°æ® (Schema) --- */}

    {/* 1. åŠ¨æ€ Schema (äº§å“é¡µ/æ–‡ç« é¡µ) */}
    {
      schema && (
        <script type="application/ld+json" set:html={JSON.stringify(schema)} />
      )
    }

    {/* 2. å›ºå®š Organization Schema (å…¨ç«™é€šç”¨) */}
    <script type="application/ld+json" set:html={JSON.stringify(orgSchema)} />
    {/* ğŸ”¥ 1. å¯ç”¨ ViewTransitions (å¯é€‰ï¼Œä½†æ¨èï¼Œèƒ½è®©åˆ‡æ¢æ›´ä¸æ»‘) */}

    {/* ğŸ”¥ 2. æ ¸å¿ƒï¼šä¸»é¢˜é˜²æŠ–åŠ¨è„šæœ¬ (å¿…é¡»æ”¾åœ¨ head æœ€ä¸Šé¢) */}
    <script is:inline>
      // å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥è®¾ç½®ä¸»é¢˜ï¼Œæ–¹ä¾¿å¤ç”¨
      function applyTheme() {
        // 1. è·å–ç”¨æˆ·è®¾ç½®
        const storedTheme =
          typeof localStorage !== 'undefined' && localStorage.getItem('theme');

        // 2. é€»è¾‘åˆ¤æ–­ï¼š
        // å¦‚æœç”¨æˆ·æ˜ç¡®è®¾ä¸º 'light'ï¼Œæ‰æ˜¾ç¤ºäº®è‰²
        // å¦åˆ™ï¼ˆæ²¡è®¾ç½®è¿‡çš„é¦–æ¬¡è®¿é—®ã€æˆ–è®¾ä¸º darkï¼‰ï¼Œä¸€å¾‹å¼ºåˆ¶æ·±è‰²
        if (storedTheme === 'light') {
          document.documentElement.classList.remove('dark');
        } else {
          document.documentElement.classList.add('dark');
          // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ¥ï¼Œé¡ºæ‰‹å­˜ä¸€ä¸‹ darkï¼Œä¿æŒçŠ¶æ€ä¸€è‡´
          if (!storedTheme) {
            localStorage.setItem('theme', 'dark');
          }
        }
      }

      // A. é¡µé¢åˆæ¬¡åŠ è½½æ—¶ï¼Œç«‹å³æ‰§è¡Œ
      applyTheme();

      // B. é€‚é… Astro View Transitions (å¦‚æœä½ ç”¨äº† client router)
      // æ¯æ¬¡é¡µé¢åˆ‡æ¢å®Œæˆåï¼Œé‡æ–°æ‰§è¡Œä¸€éï¼Œé˜²æ­¢æ ·å¼ä¸¢å¤±
      document.addEventListener('astro:after-swap', applyTheme);
    </script>
  </head>

  <body class="text-text-main flex min-h-screen flex-col antialiased">
    {/* Navbar */}
    <div
      id="main-navbar"
      transition:persist
      class="sticky top-0 z-50 h-20 w-full"
    >
      <Navbar client:load />
    </div>

    {/* ä¸»ä½“å†…å®¹ */}
    <main class="relative z-0 grow" transition:animate="fade">
      <slot />
    </main>

    {/* æ‚¬æµ®å·¥å…·æ  & Footer */}
    <FloatingTools client:load transition:persist />
    <Footer transition:persist />
  </body>
</html>

<style is:global></style>
