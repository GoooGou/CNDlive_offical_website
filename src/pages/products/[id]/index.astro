---
// src/pages/products/[id]/index.astro
import { getCollection } from 'astro:content'; // 1. 移除了没用到的 render
import type { CollectionEntry } from 'astro:content';

import ProductLayout from '@/components/products/ProductLayout.astro';
import ArticleBody from '@/components/mdx/ArticleBody.astro';

// 2. 扫描同目录下的 ts 数据文件
const specsModules = import.meta.glob('/src/content/products/**/specs.ts', {
  eager: true,
});
const downloadsModules = import.meta.glob(
  '/src/content/products/**/downloads.ts',
  { eager: true }
);

export async function getStaticPaths() {
  const posts = await getCollection('products');
  return posts.map((post) => ({
    params: { id: post.id },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'products'>;
}

const { post } = Astro.props;

// 3. ✅ 核心优化：更安全的路径匹配
// 原来的 includes(post.id) 是模糊匹配。如果有一个产品叫 'c6'，另一个叫 'c6-pro'，
// 访问 'c6' 时可能会错误加载到 'c6-pro' 的数据。
// 改为 split('/') 精确匹配文件夹名称。
const specKey = Object.keys(specsModules).find((path) =>
  path.split('/').includes(post.id)
);

const downloadKey = Object.keys(downloadsModules).find((path) =>
  path.split('/').includes(post.id)
);

// 4. 获取数据
const externalSpecs = specKey ? (specsModules[specKey] as any).specs : null;
const externalDownloads = downloadKey
  ? (downloadsModules[downloadKey] as any).downloads
  : null;
---

<ProductLayout
  post={post}
  activeTabId="overview"
  customSpecs={externalSpecs}
  customDownloads={externalDownloads}
>
  <ArticleBody post={post} />
</ProductLayout>
