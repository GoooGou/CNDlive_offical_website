---
// src/pages/products/[id]/index.astro
import { getCollection, render } from 'astro:content'; // ✅ 1. 引入 render 函数
import type { CollectionEntry } from 'astro:content';

// ⚠️ 请确认你的 ProductLayout 路径。通常建议放在 layouts 目录下。
// 如果你的文件确实在 components 里，请保持原样；如果在 layouts 里，请改为 '@/layouts/ProductLayout.astro'
import ProductLayout from '@/components/products/ProductLayout.astro';
import ArticleBody from '@/components/mdx/ArticleBody.astro';

// 2. 扫描同目录下的 ts 数据文件
const specsModules = import.meta.glob('/src/content/products/**/specs.ts', {
  eager: true,
});
const downloadsModules = import.meta.glob(
  '/src/content/products/**/downloads.ts',
  { eager: true }
);

export async function getStaticPaths() {
  const posts = await getCollection('products');
  return posts.map((post) => ({
    params: { id: post.id },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'products'>;
}

const { post } = Astro.props;

// ✅ 3. 核心修复：使用 render(post) 而不是 post.render()

// 4. 动态查找当前 ID 对应的 TS 数据文件
// 逻辑：在所有文件路径中，找到包含当前产品 ID (如 'encoder-c6') 的那个文件
const specKey = Object.keys(specsModules).find((path) =>
  path.includes(post.id)
);
const downloadKey = Object.keys(downloadsModules).find((path) =>
  path.includes(post.id)
);

// 5. 获取数据 (如果有的话，提取 .specs 或 .downloads 导出)
const externalSpecs = specKey ? (specsModules[specKey] as any).specs : null;
const externalDownloads = downloadKey
  ? (downloadsModules[downloadKey] as any).downloads
  : null;
console.log(post);
---

<ProductLayout
  post={post}
  activeTabId="overview"
  customSpecs={externalSpecs}
  customDownloads={externalDownloads}
>
  <ArticleBody post={post} />
</ProductLayout>
