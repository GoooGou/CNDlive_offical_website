---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

// ⚠️ 请根据你的实际路径调整 import
import ProductLayout from '@/components/products/ProductLayout.astro';
import DownloadList from '@/components/products/DownloadList.astro';

// 1. 扫描所有的 specs.ts 和 downloads.ts
// eager: true 表示直接加载内容
const specsModules = import.meta.glob('/src/content/products/**/specs.ts', {
  eager: true,
});
const downloadsModules = import.meta.glob(
  '/src/content/products/**/downloads.ts',
  { eager: true }
);

export async function getStaticPaths() {
  const posts = await getCollection('products');

  // 重新获取 downloadsModules 以便在 getStaticPaths 内部使用 (或者将其移到外部作用域)
  // 注意：在 getStaticPaths 内部不能直接使用外部变量，除非是 import 的
  // 这里我们用一种更简单的过滤方式：
  // 我们不过滤了，或者我们通过检查文件系统来过滤。
  // 但为了简单起见，最稳妥的方法是：先生成所有路径，然后在组件内部重定向或显示 404
  // 或者，我们可以再次 glob 一遍 (虽不优雅但有效)，或者使用下面的逻辑：

  // 更好的逻辑：只生成那些“有对应 downloads.ts 文件”的产品页面
  // 由于这里拿不到 import.meta.glob 的结果 (在构建时)，我们先返回所有产品
  // 然后在页面逻辑里处理空数据的情况
  return posts.map((post) => ({
    params: { id: post.id },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'products'>;
}

const { post } = Astro.props;

// 2. 查找当前 ID 对应的数据文件
// 逻辑：在所有文件路径中，找到包含当前产品 ID 的那个文件
const specKey = Object.keys(specsModules).find((path) =>
  path.includes(post.id)
);
const downloadKey = Object.keys(downloadsModules).find((path) =>
  path.includes(post.id)
);

// 3. 提取数据
// 这里的 as any 是为了绕过 TS 检查，因为 glob 结果类型比较复杂
const externalSpecs = specKey ? (specsModules[specKey] as any).specs : null;
const externalDownloads = downloadKey
  ? (downloadsModules[downloadKey] as any).downloads
  : null;

// 4. 路由保护：如果这个产品没有下载数据，重定向回概览页
// (这解决了 getStaticPaths 没过滤的问题)
if (!externalDownloads || externalDownloads.length === 0) {
  return Astro.redirect(`/products/${post.id}`);
}
---

{
  /* 修复说明：
  1. 移除了 basePath 和 parentTitle，因为现在的 ProductLayout 会根据 post 自动计算。
  2. 传入 customSpecs 和 customDownloads，让 Layout 知道要显示哪些 Tab。
*/
}
<ProductLayout
  post={post}
  activeTabId="download"
  customSpecs={externalSpecs}
  customDownloads={externalDownloads}
>
  <DownloadList data={externalDownloads} />
</ProductLayout>
