---
// src/layouts/ProductLayout.astro
import ContentLayout from '@/layouts/ContentLayout.astro';
import ProductTabs from '@/components/products/ProductTabs.astro';
import Cover from '@/components/common/Cover.astro';
import type { CollectionEntry } from 'astro:content';
import { SITE_CONFIG } from '@/global.config';

interface Props {
  post: CollectionEntry<'products'>;
  activeTabId: 'overview' | 'tech-specs' | 'download';
  customSpecs?: any[];
  customDownloads?: any[];
}

const { post, activeTabId, customSpecs, customDownloads } = Astro.props;
const { title, description, cover, features } = post.data;

const specsData = customSpecs;
const downloadsData = customDownloads;
const baseUrl = `/products/${post.id}`;

// 1. 生成 Tab 菜单
const tabItems = [{ id: 'overview', label: 'Overview', href: baseUrl }];

const hasBanner = SITE_CONFIG.showPromotionBanner;
// 2. Sticky 定位计算
const stickyTopClass = hasBanner ? 'top-30' : 'top-20';

if (specsData && specsData.length > 0) {
  tabItems.push({
    id: 'tech-specs',
    label: 'Tech Specs',
    href: `${baseUrl}/specs`,
  });
}

if (downloadsData && downloadsData.length > 0) {
  tabItems.push({
    id: 'download',
    label: 'Download',
    href: `${baseUrl}/downloads`,
  });
}

// 3. Schema 生成
const generateProductSchema = (post: CollectionEntry<'products'>) => {
  const siteUrl =
    Astro.site?.toString().replace(/\/$/, '') || 'https://cndlive.com';
  const coverUrl = cover?.src ? siteUrl + cover.src : undefined;

  return {
    '@context': 'https://schema.org',
    '@type': 'Product',
    name: post.data.title,
    description: post.data.description,
    image: coverUrl ? [coverUrl] : undefined,
    sku: `CND-${post.id.toUpperCase().replace(/\//g, '-')}`,
    brand: { '@type': 'Brand', name: 'CNDLive' },
    offers: {
      '@type': 'Offer',
      priceCurrency: 'USD',
      availability: 'https://schema.org/Inquire',
      url: `${siteUrl}/contact`,
    },
  };
};

const productSchema = generateProductSchema(post);
---

<ContentLayout
  title={title}
  description={description}
  image={cover?.src}
  breadcrumbItems={[]}
  schema={productSchema}
>
  {
    /* 【关键修复】Hero 区域容器
      1. 移除了 transition:persist (这是导致闪烁的元凶)
      2. 改用 transition:animate="none"
      原理：只要 transition:name 相同，Astro 会自动匹配前后两个页面的这个区域。
      设置 animate="none" 让它在切换 Tab 时不要淡入淡出，视觉上就是静止的，效果和 persist 一样但更稳定。
  */
  }
  <div
    class="not-content mx-auto mb-10 max-w-6xl px-4"
    transition:name={`product-shell-${post.id}`}
    transition:animate="none"
  >
    {/* 面包屑 */}
    <nav
      aria-label="Breadcrumb"
      class="mb-6 flex items-center text-sm text-zinc-500 dark:text-zinc-400"
    >
      <a
        href="/"
        class="transition-colors hover:text-zinc-900 dark:hover:text-white"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 20 20"
          fill="currentColor"
          class="h-5 w-5"
        >
          <path
            fill-rule="evenodd"
            d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z"
            clip-rule="evenodd"></path>
        </svg>
      </a>
      <span class="mx-2 text-zinc-300 dark:text-zinc-600">/</span>
      <a
        href="/products"
        class="transition-colors hover:text-zinc-900 dark:hover:text-white"
        >Products</a
      >
      <span class="mx-2 text-zinc-300 dark:text-zinc-600">/</span>
      <span class="font-medium text-zinc-900 dark:text-white">{title}</span>
    </nav>

    {/* Hero 内容 */}
    <div class="grid grid-cols-1 items-center gap-10 md:grid-cols-2">
      {/* 左侧封面 */}
      <div
        class="aspect-video w-full overflow-hidden rounded-2xl border border-zinc-200 shadow-sm dark:border-zinc-800"
      >
        <Cover
          src={cover}
          alt={title}
          variant="hero"
          aspect="4/3"
          loading="eager"
          className="h-full w-full"
          fit="contain"
        />
      </div>

      {/* 右侧信息 */}
      <div>
        <h1
          class="mb-4 text-3xl leading-tight font-extrabold text-zinc-900 md:text-3xl dark:text-white"
        >
          {title}
        </h1>
        <p class="text-text-main/60 mb-6 line-clamp-4 text-sm">
          {description}
        </p>

        {
          features && (
            <ul class="mb-8 space-y-2">
              {features.map((f) => (
                <li class="flex items-start gap-2 font-medium text-zinc-700 dark:text-zinc-300">
                  <span class="mt-1 text-[#AC121F]">✓</span> {f}
                </li>
              ))}
            </ul>
          )
        }

        <div class="mt-8 flex flex-wrap gap-4">
          <a
            href={`${baseUrl}/specs`}
            class="inline-flex items-center justify-center rounded-lg bg-[#AC121F] px-6 py-3 text-base font-bold text-white transition-all hover:-translate-y-0.5 hover:bg-[#c91524] hover:shadow-lg active:translate-y-0"
          >
            View Specs
          </a>

          <a
            href="/contact"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center justify-center rounded-lg border border-zinc-300 px-6 py-3 text-base font-medium text-zinc-700 transition-colors hover:border-[#AC121F] hover:bg-[#AC121F]/5 hover:text-[#AC121F] dark:border-zinc-700 dark:text-zinc-200 dark:hover:border-white dark:hover:bg-white/5 dark:hover:text-white"
          >
            Contact Sales
          </a>

          <a
            href="/support"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center justify-center rounded-lg border border-zinc-300 px-6 py-3 text-base font-medium text-zinc-700 transition-colors hover:border-[#AC121F] hover:bg-[#AC121F]/5 hover:text-[#AC121F] dark:border-zinc-700 dark:text-zinc-200 dark:hover:border-white dark:hover:bg-white/5 dark:hover:text-white"
          >
            Support
          </a>
        </div>
      </div>
    </div>
  </div>

  {/* Tab 导航 */}
  {/* animate="none" 确保导航条在切换 Tab 时也不会闪烁 */}
  <div
    class:list={[
      'sticky z-30 mb-8 border-b border-(--color-border) bg-(--color-bg-base)/80 backdrop-blur-md transition-colors duration-300',
      stickyTopClass,
    ]}
    transition:name={`product-tabs-${post.id}`}
    transition:animate="none"
  >
    <div class="mx-auto max-w-6xl px-4">
      <ProductTabs items={tabItems} activeId={activeTabId} />
    </div>
  </div>

  {/* 内容插槽：只有这里会有 fade 动画 */}
  <div class="mx-auto min-h-[40vh] max-w-6xl" transition:animate="fade">
    <slot />
  </div>
</ContentLayout>
