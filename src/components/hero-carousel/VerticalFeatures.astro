---
// src/components/VerticalFeatures.astro
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';

// ==========================================
// 1. 类型定义 & 配置
// ==========================================

interface Props {
  collectionId?: string;
}

interface PostData {
  slideImage: any;
  title: string;
  description?: string;
  pubDate?: Date | string;
  cover?: any;
  image?: any;
}

const { collectionId = 'blog' } = Astro.props;
const VIEW_ALL_HREF = `/${collectionId}`;

const BG_PRESETS: Record<string, string> = {
  black: 'bg-zinc-900',
  midnight: 'bg-slate-900',
  sunset: 'bg-indigo-950',
  forest: 'bg-green-950',
};
const THEME_KEYS = Object.keys(BG_PRESETS);

// ==========================================
// 2. 数据获取
// ==========================================

let latestPosts: any[] = [];

try {
  const allPosts = await getCollection(collectionId as any);

  const sortedPosts = allPosts.sort((a: any, b: any) => {
    const dateA = new Date(a.data.pubDate || 0).valueOf();
    const dateB = new Date(b.data.pubDate || 0).valueOf();
    return dateB - dateA;
  });

  latestPosts = sortedPosts.slice(0, 3);
} catch (error) {
  console.error('[VerticalFeatures] Error:', error);
}

if (latestPosts.length === 0) return null;

const slides = latestPosts.map((post: any, index: number) => {
  const data = post.data as PostData;
  const themeKey = THEME_KEYS[index % THEME_KEYS.length];

  return {
    title: data.title || 'Untitled Update',
    description:
      data.description ||
      'Discover the latest details in this featured update.',
    image: data.slideImage || data.cover,
    href: `/${collectionId}/${post.id}`,
    btnText: 'Read Article',
    bgClass: BG_PRESETS[themeKey] || 'bg-zinc-900',
  };
});
---

<div
  x-data={`{
    activeSlide: 0,
    totalSlides: ${slides.length},
    duration: 5000, 
    progress: 0,
    timer: null,
    frame: 50, 

    init() {
      this.startTimer();
    },

    next() {
      this.activeSlide = (this.activeSlide + 1) % this.totalSlides;
      this.progress = 0;
    },

    startTimer() {
      if (this.timer) clearInterval(this.timer);
      this.timer = setInterval(() => {
        const increment = 100 / (this.duration / this.frame);
        this.progress += increment;
        if (this.progress >= 100) {
          this.next();
        }
      }, this.frame);
    }
  }`}
  *
  鼠标交互已移除，进度条始终自动播放
  *
  class="group relative h-[580px] w-full overflow-hidden bg-black text-white lg:h-[700px]"
>
  {
    /* ==========================
      主内容滑动区域
      ========================== */
  }
  <div
    class="flex h-full flex-col transition-transform duration-700 ease-in-out will-change-transform"
    :style="`transform: translateY(-${activeSlide * 100}%)`"
  >
    {
      slides.map((slide) => (
        <div
          class={`relative flex h-full w-full shrink-0 items-center justify-center ${slide.bgClass}`}
        >
          {/* 布局调整关键点：
             1. mobile 使用 flex-col + justify-center 居中内容
             2. gap-6: 缩小移动端图片和文字的间距 (之前是 gap-8)
          */}
          <div class="relative z-10 mx-auto flex h-full w-full max-w-7xl flex-col justify-center gap-6 px-6 py-12 lg:grid lg:h-auto lg:grid-cols-2 lg:gap-12 lg:px-8 lg:py-0">
            {/* 图片区域调整：
               1. 移除 h-1/2: 不再强制占一半高度，由内容撑开
               2. aspect-video: 改为 16:9
            */}
            <div class="order-1 flex h-auto shrink-0 items-end justify-center lg:order-2 lg:h-auto lg:items-center lg:justify-end">
              {slide.image ? (
                <Image
                  src={slide.image}
                  alt={slide.title}
                  class="aspect-video w-full rounded-xl object-cover shadow-2xl ring-1 ring-white/10 lg:max-w-lg"
                  width={800}
                  height={450}
                />
              ) : (
                /* 占位图也改为 16:9 */
                <div class="flex aspect-video w-full max-w-xs items-center justify-center rounded-xl border border-white/10 bg-white/5">
                  <span class="text-xs tracking-widest text-white/30">
                    NO IMAGE
                  </span>
                </div>
              )}
            </div>

            {/* 文字区域调整：
               1. 移除 h-1/2: 不再强制占一半高度，自然堆叠
            */}
            <div class="order-2 flex h-auto flex-col justify-start lg:order-1 lg:block lg:h-auto">
              <div class="mb-3 lg:mb-4">
                <span class="inline-block rounded-full bg-white/10 px-2 py-0.5 text-[10px] font-bold tracking-wider text-white/90 uppercase lg:px-3 lg:py-1 lg:text-xs">
                  Latest {collectionId}
                </span>
              </div>

              <h2 class="mb-3 text-2xl leading-tight font-bold md:text-3xl lg:mb-6 lg:text-4xl">
                {slide.title}
              </h2>

              <p class="mb-6 line-clamp-3 text-sm text-white/80 lg:mb-8 lg:line-clamp-4 lg:text-lg">
                {slide.description}
              </p>

              <a
                href={slide.href}
                class="inline-block w-fit border-b border-white/30 pb-1 text-xs font-bold tracking-widest uppercase transition-all hover:border-white hover:text-white/70 lg:text-sm"
              >
                {slide.btnText}
              </a>
            </div>
          </div>
        </div>
      ))
    }
  </div>

  {
    /* ==========================
      底部进度条
      ========================== */
  }
  <div class="absolute bottom-0 left-0 z-20 h-1 w-full bg-white/5">
    <div
      class="h-full bg-indigo-500/80 shadow-[0_0_10px_rgba(255,255,255,0.3)] transition-all duration-100 ease-linear lg:bg-white"
      :style="`width: ${progress}%`"
    >
    </div>
  </div>

  {
    /* ==========================
      信息栏
      ========================== */
  }
  <div
    class="absolute right-6 bottom-4 left-6 z-20 flex items-end justify-between"
  >
    <div
      class="pointer-events-none font-mono text-xs tracking-widest text-white/40"
    >
      <span x-text="activeSlide + 1"></span> / {slides.length}
    </div>

    <a
      href={VIEW_ALL_HREF}
      class="group/btn flex items-center gap-2 rounded-full border border-white/5 bg-black/40 px-3 py-1.5 text-[10px] font-bold tracking-widest text-white/60 uppercase backdrop-blur-md transition-colors hover:text-white lg:text-xs"
    >
      View All
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-3 w-3 transition-transform duration-300 group-hover/btn:translate-x-1"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        ><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg
      >
    </a>
  </div>
</div>
