---
// src/components/Newsletter.astro
import { Rss } from 'lucide-react';

// ä½ çš„ Web3Forms Key
const NEWSLETTER_KEY = 'aa01d43d-5d5c-42b9-99ac-47adb38b6b5d';
---

<div
  class="girdPattern relative flex flex-col items-center justify-between gap-8 overflow-hidden rounded-2xl border border-zinc-800 p-8 lg:flex-row"
>
  {/* --- å·¦ä¾§ï¼šæ–‡æ¡ˆ + RSS æŒ‰é’® --- */}
  <div class="relative z-10 w-full text-center lg:w-5/12 lg:text-left">
    <h3 class="mb-3 text-2xl font-bold text-white">Subscribe to updates</h3>

    <p class="mb-6 text-zinc-400">
      Get the latest firmware updates, case studies, and industry news directly
      to your inbox.
    </p>

    <div class="flex justify-center lg:justify-start">
      <a
        href="/rss.xml"
        target="_blank"
        class="group /* [ä¿®æ”¹]: RSS æŒ‰é’®å¼ºåˆ¶æ·±è‰²æ ·å¼ */ hover:text-primary hover:border-primary inline-flex items-center gap-2 rounded-full border border-zinc-700 bg-zinc-900 px-4 py-2 text-sm font-medium text-zinc-300 transition-colors duration-300"
      >
        <Rss className="h-4 w-4 transition-transform group-hover:scale-110" />
        <span>Subscribe via RSS Feed</span>
      </a>
    </div>
  </div>

  {/* --- å³ä¾§ï¼šWeb3Forms è¡¨å• --- */}
  <div class="relative z-10 w-full lg:w-7/12">
    <form id="newsletter-form" class="relative">
      <input type="hidden" name="access_key" value={NEWSLETTER_KEY} />
      <input
        type="hidden"
        name="subject"
        value="New Newsletter Subscription (with Name)"
      />
      <input type="hidden" name="from_name" value="CNDLive Footer" />
      <input
        type="checkbox"
        name="botcheck"
        class="hidden"
        style="display: none;"
      />

      <div class="grid grid-cols-1 gap-3 sm:grid-cols-12">
        {/* åå­—è¾“å…¥æ¡† */}
        <div class="sm:col-span-4">
          <input
            type="text"
            name="name"
            id="newsletter-name"
            required
            placeholder="Name"
            class="/* [ä¿®æ”¹]: è¾“å…¥æ¡†å¼ºåˆ¶æ·±è‰² */ focus:ring-primary h-12 w-full rounded-lg border border-zinc-700 bg-black/50 px-4 text-white transition outline-none placeholder:text-zinc-500 focus:border-transparent focus:ring-2 disabled:opacity-50"
          />
        </div>

        {/* é‚®ç®±è¾“å…¥æ¡† */}
        <div class="sm:col-span-5">
          <input
            type="email"
            name="email"
            id="newsletter-email"
            required
            placeholder="Email address"
            class="/* [ä¿®æ”¹]: è¾“å…¥æ¡†å¼ºåˆ¶æ·±è‰² */ focus:ring-primary h-12 w-full rounded-lg border border-zinc-700 bg-black/50 px-4 text-white transition outline-none placeholder:text-zinc-500 focus:border-transparent focus:ring-2 disabled:opacity-50"
          />
        </div>

        {/* æäº¤æŒ‰é’® (ä¿æŒä¸å˜ï¼Œå› ä¸ºåŸè‰²å°±é€‚é…æ·±è‰²) */}
        <div class="sm:col-span-3">
          <button
            type="submit"
            id="newsletter-btn"
            class="bg-primary hover:bg-primary-dark shadow-primary/20 h-12 w-full rounded-lg font-bold whitespace-nowrap text-white shadow-lg transition-colors disabled:cursor-not-allowed disabled:opacity-70"
          >
            Subscribe
          </button>
        </div>
      </div>
    </form>

    <p
      id="newsletter-result"
      class="mt-3 hidden text-center text-sm lg:text-left"
    >
    </p>
  </div>
</div>

<script is:inline>
  const form = document.getElementById('newsletter-form');
  const nameInput = document.getElementById('newsletter-name');
  const emailInput = document.getElementById('newsletter-email');
  const btn = document.getElementById('newsletter-btn');
  const result = document.getElementById('newsletter-result');

  form.addEventListener('submit', function (e) {
    e.preventDefault();
    const originalText = btn.innerText;
    btn.innerText = '...';
    btn.disabled = true;
    nameInput.disabled = true;
    emailInput.disabled = true;
    result.classList.add('hidden');

    const formData = new FormData(form);
    const object = Object.fromEntries(formData);
    const json = JSON.stringify(object);

    fetch('https://api.web3forms.com/submit', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Accept: 'application/json',
      },
      body: json,
    })
      .then(async (response) => {
        let json = await response.json();
        if (response.status == 200) {
          result.innerHTML = `ğŸ‰ Thanks ${object.name || ''}! You've subscribed successfully.`;
          result.classList.remove('hidden', 'text-red-500');
          result.classList.add('text-green-500');
          form.reset();
        } else {
          console.log(response);
          result.innerHTML = json.message || 'Something went wrong.';
          result.classList.remove('hidden', 'text-green-500');
          result.classList.add('text-red-500');
        }
      })
      .catch((error) => {
        console.log(error);
        result.innerHTML = 'Network error. Please try again.';
        result.classList.remove('hidden', 'text-green-500');
        result.classList.add('text-red-500');
      })
      .then(function () {
        btn.innerText = originalText;
        btn.disabled = false;
        nameInput.disabled = false;
        emailInput.disabled = false;
        setTimeout(() => {
          if (result.classList.contains('text-green-500')) {
            result.classList.add('hidden');
          }
        }, 5000);
      });
  });
</script>

<style>
  /* From Uiverse.io by milegelu */
  .girdPattern {
    width: 100%;
    height: 100%;
    /* ç¡®ä¿è¿™ä¸ªèƒŒæ™¯è‰²æ˜¯ä½ æƒ³è¦çš„æ·±è‰² */
    background: #141414;
    --gap: 5em;
    --line: 1px;
    --color: rgba(95, 95, 95, 0.2);

    background-image:
      linear-gradient(
        -90deg,
        transparent calc(var(--gap) - var(--line)),
        var(--color) calc(var(--gap) - var(--line) + 1px),
        var(--color) var(--gap)
      ),
      linear-gradient(
        0deg,
        transparent calc(var(--gap) - var(--line)),
        var(--color) calc(var(--gap) - var(--line) + 1px),
        var(--color) var(--gap)
      );
    background-size: var(--gap) var(--gap);
  }
</style>
