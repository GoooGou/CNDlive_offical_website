---
// 文件: src/components/common/IMG.astro
import type { HTMLAttributes } from 'astro/types';
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

// --- 类型定义 ---
// 允许 src 为字符串(原生) 或 对象(Astro优化)，或者空
type Props = Omit<HTMLAttributes<'img'>, 'src'> & {
  src: ImageMetadata | string | null | undefined;
  alt: string;
  /** 强制使用原生 <img> 标签 (例如外部CDN链接) */
  raw?: boolean;
};

const {
  src,
  alt,
  raw = false,
  class: className = '',
  ...rest
} = Astro.props;

// --- 逻辑处理 ---
const isValidSrc = src !== null && src !== undefined && src !== '';
const isStringSrc = typeof src === 'string';
const useNative = raw || isStringSrc;

// 获取原生 img 标签需要的字符串路径
const nativeSrc = !useNative && src && 'src' in src 
  ? src.src 
  : (src as string);

// --- 核心功能: 图片加载后的淡入动画 ---
// 默认透明(opacity-0)，加载完移除透明类
const transitionClass = "transition-opacity duration-500 ease-in-out opacity-0";
const onLoadHandler = "this.classList.remove('opacity-0')";

if (!isValidSrc) {
  // 如果没有 src，直接不渲染，或者根据需求渲染一个空占位
  // 这里选择不渲染，由父组件决定如何处理 "无图" 的情况
  return null;
}
---

{
  useNative ? (
    <img
      src={nativeSrc}
      alt={alt}
      loading="lazy"
      class:list={[transitionClass, className]}
      onload={onLoadHandler}
      {...rest}
    />
  ) : (
    <Image
      src={src as ImageMetadata}
      alt={alt}
      class:list={[transitionClass, className]}
      {...rest}
      /* 绕过 TS 检查注入 onload */
      {...({ onload: onLoadHandler } as any)}
    />
  )
}