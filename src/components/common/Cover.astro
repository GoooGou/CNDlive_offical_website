---
// 文件名: Cover.astro
import IMG from './IMG.astro';
import { clsx } from 'clsx';
// ✅ 1. 确保引入了模糊背景组件
import BlurBG from '@/components/design/background/BlurBackground.astro';

// ===================================
// Props & Interfaces
// ===================================

interface Props {
  src?: any;
  alt: string;
  title?: string;
  className?: string;
  raw?: boolean;
  variant?: 'hero' | 'list';
  loading?: 'eager' | 'lazy';
  aspect?: '16/9' | '4/3' | '1/1' | 'auto';
  border?: boolean;

  forcePattern?: 'grid' | 'dots' | 'none';
  // forceBlob 已经不再需要了，因为我们现在用 BlurBG 替代了手动 blob
  forceBlob?: boolean;
}

const {
  src,
  alt,
  title = 'CNDLive',
  className = '',
  raw = false,
  variant = 'list',
  loading = variant === 'hero' ? 'eager' : 'lazy',
  aspect = 'auto',
  border = false,
  forcePattern,
} = Astro.props;

// --- 哈希函数 (保持不变) ---
const getHashIndex = (str: string) => {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  return Math.abs(hash);
};

const hashIndex = getHashIndex(title);

// --- 🎨 深色渐变色板 (作为 BlurBG 的底色) ---
const gradients = [
  'from-zinc-800 via-neutral-900 to-black',
  'from-slate-900 via-blue-950 to-black',
  'from-gray-900 via-indigo-950 to-slate-900',
  'from-emerald-950 via-teal-950 to-gray-900',
  'from-red-950 via-orange-950 to-black',
];

const themeClass = gradients[hashIndex % gradients.length];
const hasImage = !!src;

// --- 比例映射 ---
const aspectStyles = {
  '16/9': 'aspect-video',
  '4/3': 'aspect-[4/3]',
  '1/1': 'aspect-square',
  auto: '',
};

// --- 字体与质感样式 ---
const variantStyles = {
  hero: {
    wrapper: 'p-8 md:p-12',
    text: 'text-3xl sm:text-4xl font-black leading-tight tracking-wide',
    clamp: '',
  },
  list: {
    wrapper: 'p-6',
    text: 'text-xl md:text-2xl font-bold leading-snug tracking-tight',
    clamp: 'line-clamp-3',
  },
};

const currentStyle = variantStyles[variant];

// ===================================
// Pattern 逻辑
// ===================================
const patternOptions = ['grid', 'dots', 'none'] as const;
const defaultPattern = patternOptions[hashIndex % 3];
const enablePattern = hashIndex % 10 !== 0;
const finalPattern = forcePattern || (enablePattern ? defaultPattern : 'none');

const patternsCss = {
  none: '',
  grid: `background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px); background-size: 30px 30px;`,
  dots: `background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 20px 20px;`,
};
---

<div
  class={clsx(
    'group relative w-full h-full overflow-hidden bg-zinc-900',
    aspectStyles[aspect],
    className
  )}
>
  {
    hasImage ? (
      /* --- 情况 A: 有图片 --- */
      <IMG
        src={src}
        alt={alt}
        title={title}
        raw={raw}
        loading={loading}
        class={clsx(
          'h-full w-full object-cover duration-700',
          !raw && 'transition-transform group-hover:scale-105'
        )}
      />
    ) : (
      /* --- 情况 B: 无图片，使用 BlurBG + 渐变 --- */
      <div
        class={clsx(
          'absolute inset-0 h-full w-full overflow-hidden duration-700',
          // 这里的 themeClass 为 BlurBG 提供一个深色的基调，避免太亮
          'bg-gradient-to-br',
          themeClass,
          !raw && 'transition-transform group-hover:scale-105'
        )}
      >
        {/* ✅ 2. 嵌入动态模糊光效背景 */}
        <div class="absolute inset-0 opacity-80 mix-blend-hard-light">
          <BlurBG />
        </div>

        {/* ✅ 3. 纹理层 (Grid/Dots) 覆盖在光效之上，增加质感 */}
        <div
          class="absolute inset-0 z-10 opacity-60"
          style={patternsCss[finalPattern as keyof typeof patternsCss]}
        />
      </div>
    )
  }

  {/* ================= Layer 2: 内容合成层 (Title & Slot) ================= */}
  <div
    class={clsx(
      'relative z-20 flex h-full w-full flex-col items-center justify-center text-center',
      currentStyle.wrapper
    )}
  >
    <div class="relative z-10 mx-auto w-full max-w-4xl">
      <h3
        class={clsx(
          'wrap-break-word hyphens-auto text-white',
          currentStyle.text,
          currentStyle.clamp
        )}
        style="text-shadow: 0 2px 10px rgba(0,0,0,0.8);"
      >
        {title}
      </h3>
    </div>

    {/* 插槽 */}
    <div class="relative z-30 mt-4">
      <slot />
    </div>
  </div>

  {/* 边框 */}
  {
    border && (
      <div class="pointer-events-none absolute inset-0 z-40 rounded-[inherit] ring-1 ring-white/10 ring-inset" />
    )
  }
</div>
