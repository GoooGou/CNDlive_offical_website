---
// 文件名: Cover.astro
import IMG from './IMG.astro';
import { clsx } from 'clsx'; 

// ===================================
// Props & Interfaces
// ===================================

interface Props {
  src?: any;
  alt: string;
  title?: string; 
  className?: string;
  raw?: boolean;
  variant?: 'hero' | 'list';
  loading?: 'eager' | 'lazy';
  aspect?: '16/9' | '4/3' | '1/1' | 'auto'; // 比例
  border?: boolean; // 是否显示边框

  // 🔥 背景设计控制 (保留，用于无图模式)
  forcePattern?: 'grid' | 'dots' | 'none';
  forceBlob?: boolean;
}

const {
  src,
  alt,
  title = 'CNDLive',
  className = '',
  raw = false,
  variant = 'list',
  loading = variant === 'hero' ? 'eager' : 'lazy',
  aspect = 'auto', // 默认不强制，由父级控制
  border = false, // 默认无边框
  // 移除 overlay 相关 props
  forcePattern,
  forceBlob,
} = Astro.props;

// --- 1. 哈希函数 (保持不变) ---
const getHashIndex = (str: string) => {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  return Math.abs(hash);
};

const hashIndex = getHashIndex(title);

// --- 2. 🎨 升级后的深色渐变色板 (保持不变) ---
const gradients = [
  'from-zinc-800 via-neutral-900 to-black',
  'from-slate-900 via-blue-950 to-black',
  'from-gray-900 via-indigo-950 to-slate-900',
  'from-emerald-950 via-teal-950 to-gray-900',
  'from-red-950 via-orange-950 to-black',
];

const themeClass = gradients[hashIndex % gradients.length];
const hasImage = !!src;

// --- 3. 比例映射 (保持不变) ---
const aspectStyles = {
  '16/9': 'aspect-video',
  '4/3': 'aspect-[4/3]',
  '1/1': 'aspect-square',
  auto: '',
};

// --- 4. 字体与质感样式 (保持不变) ---
const variantStyles = {
  hero: {
    wrapper: 'p-8 md:p-12',
    text: 'text-3xl sm:text-4xl font-black leading-tight tracking-wide',
    clamp: '',
  },
  list: {
    wrapper: 'p-6',
    text: 'text-xl md:text-2xl font-bold leading-snug tracking-tight',
    clamp: 'line-clamp-3',
  },
};

const currentStyle = variantStyles[variant];


// ===================================
// 🔥 随机/强制 背景装饰逻辑 (保持不变)
// ===================================

// A. Pattern 逻辑
const patternOptions = ['grid', 'dots', 'none'] as const;
const defaultPattern = patternOptions[hashIndex % 3]; 
const enablePattern = (hashIndex % 10) !== 0; 
const finalPattern = forcePattern || (enablePattern ? defaultPattern : 'none');

const patternsCss = {
  none: '',
  grid: `background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px); background-size: 30px 30px;`,
  dots: `background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 20px 20px;`,
};

// B. Blob 逻辑
const finalBlob = forceBlob !== undefined ? forceBlob : (hashIndex % 2) === 0;

---

<div
  class={clsx(
    "group relative w-full h-full overflow-hidden bg-zinc-900", 
    aspectStyles[aspect], 
    className
  )}
>
  {
    hasImage ? (
      /* --- 情况 A: 有图片 (移除覆盖层) --- */
      <>
        <IMG
          src={src}
          alt={alt}
          title={title}
          raw={raw}
          loading={loading}
          class={clsx(
            // IMG 位于背景层 (z-0)，但由于是容器中的第一个元素，不需要显式 z-index
            "h-full w-full object-cover duration-700",
            !raw && "transition-transform group-hover:scale-105" 
          )}
        />
        {/* ❌ 移除图片背景下的变暗覆盖层 div */}
      </>
    ) : (
      /* --- 情况 B: 无图片，深色渐变背景 --- */
      <div
        class={clsx(
          "absolute inset-0 h-full w-full bg-gradient-to-br duration-700",
          !raw && "transition-transform group-hover:scale-105", 
          themeClass
        )}
        style={patternsCss[finalPattern as keyof typeof patternsCss]} 
      >
        {/* 1.1 装饰层 - 光斑 (Blob) */}
        {finalBlob && ( 
          <>
            <div class="absolute -top-[20%] -left-[10%] w-[50%] h-[50%] rounded-full bg-primary/20 blur-[80px] mix-blend-screen animate-pulse" />
            <div class="absolute top-[40%] -right-[10%] w-[40%] h-[40%] rounded-full bg-blue-500/10 blur-[60px] mix-blend-screen" />
          </>
        )}
      </div>
    )
  }

  {/* ================= Layer 2: 内容合成层 (Title & Slot) ================= */}
  <div
    class={clsx(
      // z-20 确保内容在图片/渐变背景之上
      "relative z-20 flex h-full w-full flex-col items-center justify-center text-center",
      currentStyle.wrapper // 应用 padding/wrapper 样式
    )}
  >
    <div class="relative z-10 mx-auto w-full max-w-4xl">
      <h3
        class={clsx(
          "wrap-break-word hyphens-auto text-white",
          currentStyle.text,
          currentStyle.clamp
        )}
        style="text-shadow: 0 0 10px rgba(0,0,0,0.8);" 
      >
        {title}
      </h3>
    </div>
    
    {/* 默认插槽 (供用户放置链接或按钮) */}
    <div class="relative z-30 mt-4">
      <slot />
    </div>

  </div>
  
  {/* 可选的内边框 (Overlay Ring) --- 保持原始功能 --- */}
  {
    border && (
      <div class="pointer-events-none absolute inset-0 rounded-[inherit] ring-1 ring-white/10 ring-inset z-40" />
    )
  }
</div>