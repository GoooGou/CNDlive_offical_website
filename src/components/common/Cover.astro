---
// 文件名: src/components/Cover.astro
import IMG from '@/components/common/IMG.astro';
import BlurBG from '@/components/design/background/BlurBackground.astro';
import { clsx } from 'clsx';

// ===================================
// Props & Interfaces
// ===================================

interface Props {
  src?: any;
  alt: string;
  title?: string;
  className?: string;

  variant?: 'hero' | 'list';
  aspect?: '16/9' | '4/3' | '1/1' | 'auto' | string | number;
  fit?: 'cover' | 'contain' | 'fill' | 'none' | 'scale-down';

  border?: boolean;

  // 纹理与主题
  forcePattern?: 'grid' | 'dots' | 'none';
  patternOpacity?: number;
  color?: string;
  theme?: 'dark' | 'light';

  raw?: boolean;
  loading?: 'eager' | 'lazy';
}

const {
  src,
  alt,
  title = 'CNDLive',
  className = '',
  variant = 'list',
  aspect = 'auto',
  fit = 'cover',
  border = false,

  forcePattern,
  patternOpacity = 0.5, // 点阵比较细，默认不透明度稍微高一点点

  color,
  theme = 'dark',

  raw = false,
  loading = variant === 'hero' ? 'eager' : 'lazy',
} = Astro.props;

const hasImage = src !== null && src !== undefined && src !== '';

// --- 样式逻辑计算 ---
const getHashIndex = (str: string) => {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  return Math.abs(hash);
};
const hashIndex = getHashIndex(title);

const darkGradients = [
  'from-zinc-800 via-neutral-900 to-black',
  'from-slate-900 via-blue-950 to-black',
  'from-gray-900 via-indigo-950 to-slate-900',
  'from-emerald-950 via-teal-950 to-gray-900',
  'from-red-950 via-orange-950 to-black',
];
const lightGradients = [
  'from-blue-50 via-indigo-50 to-white',
  'from-emerald-50 via-teal-50 to-white',
  'from-orange-50 via-amber-50 to-white',
  'from-rose-50 via-pink-50 to-white',
  'from-slate-100 via-zinc-50 to-white',
];
const activePalette = theme === 'light' ? lightGradients : darkGradients;
const themeClass = color || activePalette[hashIndex % activePalette.length];

// --- 纹理样式定义 ---
// ✅ Dots (点阵): 使用灰色，适配亮/暗双模式
const dotsPatternStyle = {
  backgroundImage:
    'radial-gradient(rgba(128,128,128,0.25) 1.5px, transparent 1.5px)',
  backgroundSize: '20px 20px', // 点的间距
};

const gridPatternStyle = {
  backgroundImage:
    'linear-gradient(rgba(128,128,128,0.15) 1px, transparent 1px), linear-gradient(90deg, rgba(128,128,128,0.15) 1px, transparent 1px)',
  backgroundSize: '30px 30px',
};

// 决定最终纹理 (无图模式使用)
const patternOptions = ['grid', 'dots', 'none'] as const;
const defaultPattern = patternOptions[hashIndex % 3];
const enablePattern = hashIndex % 10 !== 0;
const finalPattern = forcePattern || (enablePattern ? defaultPattern : 'none');

const patternsCss: Record<string, any> = {
  none: {},
  grid: gridPatternStyle,
  dots: dotsPatternStyle,
};

// 比例样式
const aspectPresets: Record<string, string> = {
  '16/9': 'aspect-video',
  '4/3': 'aspect-[4/3]',
  '1/1': 'aspect-square',
  auto: '',
};
const presetClass = aspectPresets[String(aspect)];
const customStyle =
  !presetClass && aspect !== 'auto' ? { aspectRatio: String(aspect) } : {};

const textColorClass = theme === 'light' ? 'text-zinc-800' : 'text-white';
const variantStyles = {
  hero: {
    wrapper: 'p-8 md:p-12',
    text: 'text-3xl sm:text-4xl font-black',
    clamp: '',
  },
  list: {
    wrapper: 'p-6',
    text: 'text-xl md:text-2xl font-bold',
    clamp: 'line-clamp-3',
  },
};
const currentStyle = variantStyles[variant];
---

<div
  class={clsx(
    // 基础背景：亮色白灰 / 暗色纯黑
    'group relative w-full h-full overflow-hidden bg-zinc-50 dark:bg-black',
    presetClass,
    className
  )}
  style={customStyle}
>
  {
    /* ===========================================
    场景 A: 有图模式 (Image Mode)
    逻辑：纯色背景 + Dots 点阵 + 图片
  =========================================== */
  }
  {
    hasImage && (
      <>
        {/* A1. 背景纹理层 (垫在图片底下) */}
        <div
          class="pointer-events-none absolute inset-0 z-0 opacity-60"
          style={dotsPatternStyle}
        />

        {/* A2. 图片层 */}
        <IMG
          src={src}
          alt={alt}
          raw={raw}
          loading={loading}
          class={clsx(
            'absolute inset-0 z-10 h-full w-full duration-700 ease-in-out',
            `object-${fit}`,
            !raw && 'transition-transform group-hover:scale-105'
          )}
        />
      </>
    )
  }

  {
    /* ===========================================
    场景 B: 无图模式 (Fallback Mode)
    逻辑：渐变背景 + BlurBG 光效 + 纹理 + 标题
  =========================================== */
  }
  {
    !hasImage && (
      <>
        {/* B1. 背景渐变 & 光效 */}
        <div
          class={clsx(
            'absolute inset-0 z-0 h-full w-full bg-gradient-to-br',
            themeClass,
            !raw && 'transition-transform duration-700 group-hover:scale-105'
          )}
        >
          {theme === 'dark' && (
            <div class="absolute inset-0 opacity-60 mix-blend-hard-light">
              <BlurBG />
            </div>
          )}
        </div>

        {/* B2. 装饰纹理 (根据 hash 或 props 决定) */}
        <div
          class="pointer-events-none absolute inset-0 z-10"
          style={{
            ...patternsCss[finalPattern],
            opacity: patternOpacity,
          }}
        />

        {/* B3. 标题内容 */}
        <div
          class={clsx(
            'relative z-20 flex h-full w-full flex-col items-center justify-center text-center',
            currentStyle.wrapper
          )}
        >
          <div class="relative z-10 mx-auto w-full max-w-4xl">
            <h3
              class={clsx(
                'wrap-break-word hyphens-auto',
                textColorClass,
                currentStyle.text,
                currentStyle.clamp
              )}
            >
              {title}
            </h3>
          </div>
        </div>
      </>
    )
  }

  {
    /* ===========================================
    Layer X: 插槽 & 边框 (始终显示)
  =========================================== */
  }
  <div
    class="pointer-events-none absolute inset-0 z-40 flex items-center justify-center"
  >
    <div class="pointer-events-auto">
      <slot />
    </div>
  </div>

  {
    border && (
      <div class="pointer-events-none absolute inset-0 z-50 rounded-[inherit] ring-1 ring-black/5 ring-inset dark:ring-white/10" />
    )
  }
</div>
