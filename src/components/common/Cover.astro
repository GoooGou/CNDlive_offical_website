---
import IMG from './IMG.astro';

interface Props {
  src?: any;
  alt: string;
  title?: string;
  className?: string;
  raw?: boolean;
  variant?: 'hero' | 'list';
  loading?: 'eager' | 'lazy';
  // ğŸ”¥ æ–°å¢å‚æ•°
  aspect?: '16/9' | '4/3' | '1/1' | 'auto'; // æ¯”ä¾‹
  border?: boolean; // æ˜¯å¦æ˜¾ç¤ºè¾¹æ¡†
}

const {
  src,
  alt,
  title = 'CNDLive',
  className = '',
  raw = false,
  variant = 'list',
  loading = variant === 'hero' ? 'eager' : 'lazy',
  aspect = 'auto', // é»˜è®¤ä¸å¼ºåˆ¶ï¼Œç”±çˆ¶çº§æ§åˆ¶
  border = false, // é»˜è®¤æ— è¾¹æ¡†
} = Astro.props;

// --- 1. å“ˆå¸Œå‡½æ•° (ä¿æŒä¸å˜) ---
const getHashIndex = (str: string) => {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  return Math.abs(hash);
};

// --- 2. ğŸ¨ å‡çº§åçš„æ·±è‰²æ¸å˜è‰²æ¿ (æ‹’ç»æ˜äº®ï¼Œè¿½æ±‚è´¨æ„Ÿ) ---
const gradients = [
  // æ·±ç©ºç°/å·¥ä¸šé»‘
  'bg-gradient-to-br from-zinc-800 via-neutral-900 to-black',
  // æ·±æµ·è“ (å•†åŠ¡/ç§‘æŠ€)
  'bg-gradient-to-br from-slate-900 via-blue-950 to-black',
  // æš—å¤œç´« (é«˜ç«¯/ç¥ç§˜)
  'bg-gradient-to-br from-gray-900 via-indigo-950 to-slate-900',
  // å¢¨ç»¿è‰² (ç¨³é‡)
  'bg-gradient-to-br from-emerald-950 via-teal-950 to-gray-900',
  // æš—çº¢/é»‘é‡‘ (å¼ºè°ƒ)
  'bg-gradient-to-br from-red-950 via-orange-950 to-black',
];

const themeClass = gradients[getHashIndex(title) % gradients.length];
const hasImage = !!src;

// --- 3. æ¯”ä¾‹æ˜ å°„ ---
const aspectStyles = {
  '16/9': 'aspect-video',
  '4/3': 'aspect-[4/3]',
  '1/1': 'aspect-square',
  auto: '',
};

// --- 4. å­—ä½“ä¸è´¨æ„Ÿæ ·å¼ ---
const variantStyles = {
  hero: {
    wrapper: 'p-8 md:p-12',
    // å¢åŠ  drop-shadow å¢å¼ºå›¾ç‰‡ä¸Šçš„æ–‡å­—
    text: 'text-3xl sm:text-4xl font-black leading-tight tracking-wide',
    clamp: '',
  },
  list: {
    wrapper: 'p-6',
    text: 'text-xl md:text-2xl font-bold leading-snug tracking-tight',
    clamp: 'line-clamp-3',
  },
};

const currentStyle = variantStyles[variant];
---

<div
  class={`
    relative w-full h-full overflow-hidden 
    bg-zinc-900 
    ${aspectStyles[aspect]} 
    ${className}
  `}
>
  {
    hasImage ? (
      /* --- æƒ…å†µ A: æœ‰å›¾ç‰‡ --- */
      <IMG
        src={src}
        alt={alt}
        title={title}
        raw={raw}
        loading={loading}
        class="h-full w-full object-cover transition-transform duration-700 group-hover:scale-105"
      />
    ) : (
      /* --- æƒ…å†µ B: æ— å›¾ç‰‡ï¼Œæ·±è‰²æ¸å˜èƒŒæ™¯ --- */
      <div
        class={`flex h-full w-full flex-col items-center justify-center text-center transition-transform duration-700 group-hover:scale-105 ${currentStyle.wrapper} ${themeClass} `}
      >
        <div class="relative z-10 mx-auto w-full max-w-4xl">
          {/* ğŸ”¥ å¢åŠ  text-shadow æ ·å¼ */}
          <h3
            class={`wrap-break-word hyphens-auto text-white ${currentStyle.text} ${currentStyle.clamp}`}
            style="text-shadow: 0 4px 12px rgba(0,0,0,0.8), 0 2px 4px rgba(0,0,0,0.6);"
          >
            {title}
          </h3>
        </div>
      </div>
    )
  }

  {/* ğŸ”¥ å¯é€‰çš„å†…è¾¹æ¡† (Overlay Ring) */}
  {
    border && (
      <div class="pointer-events-none absolute inset-0 rounded-[inherit] ring-1 ring-white/10 ring-inset" />
    )
  }
</div>
