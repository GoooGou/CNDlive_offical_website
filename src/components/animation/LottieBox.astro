---
// src/components/common/LottieBox.astro
interface Props {
  /** * Lottie JSON æ–‡ä»¶çš„è·¯å¾„
   * (å»ºè®®æ”¾åœ¨ public ç›®å½•ï¼Œä¼ å…¥å¦‚ "/lottie/animation.json")
   */
  src: string;

  /** æ˜¯å¦å¾ªç¯æ’­æ”¾ï¼Œé»˜è®¤ true */
  loop?: boolean;

  /** æ˜¯å¦è‡ªåŠ¨æ’­æ”¾ï¼Œé»˜è®¤ true */
  autoplay?: boolean;

  /** * è§¦å‘æ¨¡å¼
   * - 'viewport': è¿›å…¥è§†å£è‡ªåŠ¨æ’­æ”¾ (é»˜è®¤)
   * - 'hover': é¼ æ ‡æ‚¬åœæ—¶æ’­æ”¾ï¼Œç§»å¼€åœæ­¢
   * - 'click': ç‚¹å‡»æ’­æ”¾
   */
  trigger?: 'viewport' | 'hover' | 'click';

  /** å®¹å™¨ç±»å (ç”¨äºæ§åˆ¶å®½é«˜) */
  class?: string;
}

const {
  src,
  loop = true,
  autoplay = true,
  trigger = 'viewport',
  class: className,
} = Astro.props;
---

<div
  class:list={['lottie-container', className]}
  data-src={src}
  data-loop={loop.toString()}
  data-autoplay={autoplay.toString()}
  data-trigger={trigger}
>
</div>

<script>
  // åŠ¨æ€å¯¼å…¥ lottie-web çš„è½»é‡ç‰ˆæœ¬ï¼Œå‡å°‘æ‰“åŒ…ä½“ç§¯
  import lottie from 'lottie-web/build/player/lottie_light';

  const initLottie = () => {
    const containers = document.querySelectorAll('.lottie-container');
    if (containers.length === 0) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const container = entry.target as HTMLElement;

            // é˜²æ­¢é‡å¤åˆå§‹åŒ–
            if (container.getAttribute('data-loaded') === 'true') return;

            const src = container.dataset.src!;
            const loop = container.dataset.loop === 'true';
            const autoplay = container.dataset.autoplay === 'true';
            const trigger = container.dataset.trigger;

            // ğŸ”¥ åˆå§‹åŒ–åŠ¨ç”»
            const animation = lottie.loadAnimation({
              container: container,
              renderer: 'svg',
              loop: loop,
              autoplay: autoplay && trigger === 'viewport', // åªæœ‰ viewport æ¨¡å¼æ‰åœ¨è¿™é‡Œè‡ªåŠ¨æ’­æ”¾
              path: src, // JSON è·¯å¾„
            });

            // æ ‡è®°å·²åŠ è½½
            container.setAttribute('data-loaded', 'true');

            // --- å¤„ç†äº¤äº’é€»è¾‘ ---

            // 1. Hover æ¨¡å¼
            if (trigger === 'hover') {
              container.addEventListener('mouseenter', () => animation.play());
              container.addEventListener('mouseleave', () => animation.stop()); // æˆ–è€… .pause()
            }

            // 2. Click æ¨¡å¼
            if (trigger === 'click') {
              container.addEventListener('click', () => {
                animation.goToAndPlay(0, true);
              });
            }

            // èµ„æºä¼˜åŒ–ï¼šåŠ è½½å®Œæˆåï¼Œå–æ¶ˆå¯¹è¯¥å…ƒç´ çš„ç›‘å¬
            observer.unobserve(container);
          }
        });
      },
      { threshold: 0.1 }
    ); // éœ²å‡º 10% å¼€å§‹åŠ è½½

    containers.forEach((c) => observer.observe(c));
  };

  document.addEventListener('astro:page-load', initLottie);
  document.addEventListener('DOMContentLoaded', initLottie);
</script>
