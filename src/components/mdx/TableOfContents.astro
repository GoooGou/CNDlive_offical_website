---
import type { MarkdownHeading } from 'astro';

interface Props {
  headings: MarkdownHeading[];
}

const { headings } = Astro.props;

// 1. ä¿®æ”¹è¿‡æ»¤é€»è¾‘ï¼šå…è®¸æ‰€æœ‰ H1 ~ H6 (æˆ–è€…æ ¹æ®ä½ çš„éœ€æ±‚ä¿ç•™ H1)
const toc = headings; 
---

<nav class="toc-container">
  <div class="mb-4 text-sm font-bold text-zinc-400 uppercase tracking-wider">
    On this page
  </div>
  
  <ul class="flex flex-col space-y-2 text-sm">
    {toc.map((heading) => (
      <li>
        <a 
          href={`#${heading.slug}`} 
          class="toc-link block transition-all duration-200 text-zinc-500 hover:text-white border-l-2 border-transparent py-1"
          data-slug={heading.slug}
          // 2. åŠ¨æ€ç¼©è¿›ï¼šæ ¹æ® depth è‡ªåŠ¨è®¡ç®— padding-left
          // H1=0rem, H2=0.75rem, H3=1.5rem ...
          style={`padding-left: ${(heading.depth - 1) * 0.75}rem`}
        >
          {heading.text}
        </a>
      </li>
    ))}
  </ul>
</nav>

<script>
  // æ ·å¼é…ç½®
  const ACTIVE_CLASS = ['text-red-600', 'font-bold', 'border-red-600', 'bg-red-500/5']; 
  const INACTIVE_CLASS = ['text-zinc-500', 'border-transparent']; 

  const links = document.querySelectorAll('.toc-link');
  const headers = document.querySelectorAll('article h1, article h2, article h3, article h4, article h5, article h6');

  // æ ¸å¿ƒå‡½æ•°ï¼šè®¾ç½®æ¿€æ´»çŠ¶æ€
  function setActive(id) {
    links.forEach((link) => {
      const linkSlug = link.getAttribute('data-slug');
      if (linkSlug === id) {
        link.classList.remove(...INACTIVE_CLASS);
        link.classList.add(...ACTIVE_CLASS);
      } else {
        link.classList.remove(...ACTIVE_CLASS);
        link.classList.add(...INACTIVE_CLASS);
      }
    });
  }

  // ğŸ”¥ 3. ç‚¹å‡»äº‹ä»¶ç›‘å¬ (Click Handler)
  // ç‚¹å‡»æ—¶ï¼Œä¸ç®¡ Observer è¯´ä»€ä¹ˆï¼Œå¼ºåˆ¶æ¿€æ´»å½“å‰ç‚¹å‡»é¡¹
  links.forEach((link) => {
    link.addEventListener('click', (e) => {
      // è¿™é‡Œçš„é€»è¾‘ç¡®ä¿ç‚¹å‡»ç¬é—´å°±å˜çº¢ï¼Œä¸ä¼šé—ªçƒ
      const slug = link.getAttribute('data-slug');
      setActive(slug);
      
      // æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦ preventDefaultï¼Œè®©å®ƒè‡ªç„¶é”šç‚¹è·³è½¬å³å¯
      // æµè§ˆå™¨æ»šåŠ¨æ—¶ä¼šè‡ªåŠ¨è§¦å‘ä¸‹æ–¹çš„ Observerï¼Œä½†å› ä¸ºæˆ‘ä»¬å·²ç»é«˜äº®äº†ï¼Œè§†è§‰ä¸Šæ˜¯è¿ç»­çš„
    });
  });

  // ğŸ”¥ 4. æ»šåŠ¨ç›‘å¬ (Scroll Observer)
  const observerCallback = (entries) => {
    // æ‰¾å‡ºæ‰€æœ‰æ­£åœ¨è§†å£ä¸­çš„æ ‡é¢˜
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        setActive(entry.target.id);
      }
    });
  };

  const observerOptions = {
    root: null,
    // å…³é”®è°ƒæ•´ï¼š
    // 0px 0px -80% 0px æ„å‘³ç€ï¼šæˆ‘ä»¬åœ¨å±å¹•é¡¶éƒ¨åˆ’äº†ä¸€é“çº¿ (top 20% åŒºåŸŸ)
    // åªæœ‰å½“æ ‡é¢˜ç©¿è¿‡è¿™æ¡çº¿æ—¶ï¼Œæ‰è§¦å‘æ¿€æ´»ã€‚è¿™æ ·æ¯” threshold æ›´å‡†ã€‚
    rootMargin: '0px 0px -80% 0px',
    threshold: 0 // åªè¦ç¢°åˆ°ä¸€ç‚¹ç‚¹å°±ç®—
  };

  const observer = new IntersectionObserver(observerCallback, observerOptions);

  headers.forEach((header) => {
    observer.observe(header);
  });
</script>

<style>
  .toc-container {
    max-height: calc(100vh - 200px);
    overflow-y: auto;
    scrollbar-width: none;
  }
</style>