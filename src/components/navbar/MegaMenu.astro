---
// src/components/navbar/MegaMenu.astro
interface Props {
  groups: any[];
}

const { groups = [] } = Astro.props;
---

<div
  class="mega-menu-container invisible fixed top-20 left-0 z-40 w-full -translate-y-4 border-b border-white/10 bg-[#050505] opacity-0 backdrop-blur-xl transition-all duration-500 ease-in-out group-hover/menu-item:visible group-hover/menu-item:translate-y-0 group-hover/menu-item:opacity-100"
>
  <div class="mx-auto max-w-7xl px-6 lg:px-8">
    <div class="grid grid-cols-4 gap-x-8 gap-y-10 py-8">
      {
        groups.map((group: any) => (
          <div class="space-y-4">
            <h3 class="border-b border-white/10 pb-2 text-sm leading-6 font-bold text-white">
              {group.title}
            </h3>

            <ul role="list" class="space-y-3">
              {group.items?.map((item: any) => (
                <li>
                  <a
                    href={item.href}
                    class="mega-menu-link -ml-2 flex items-center gap-2 rounded-md px-2 py-1 text-sm leading-6 text-gray-400 hover:bg-white/5 hover:text-white"
                  >
                    <span class="group-hover:bg-primary/50 h-4 w-1 rounded-full bg-transparent" />

                    <span class="link-text relative">{item.label}</span>

                    {item.badge && (
                      <span class="bg-primary/10 text-primary ml-auto rounded-full px-2 py-0.5 text-xs font-medium">
                        {item.badge}
                      </span>
                    )}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        ))
      }
    </div>
  </div>
</div>

<style>
  /* 强制关闭样式 */
  .force-close {
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none !important;
    transform: translateY(-1rem) !important;
    transition: none !important;
  }

  /* 点击时的链接高亮锁定 */
  .link-clicked {
    color: white !important;
    background-color: rgba(255, 255, 255, 0.05) !important;
  }
</style>

<script>
  const initMegaMenu = () => {
    const containers = document.querySelectorAll('.mega-menu-container');
    const links = document.querySelectorAll('.mega-menu-link');

    // 1. 初始化清理
    containers.forEach((c) => c.classList.remove('force-close'));

    // 2. 点击事件处理
    links.forEach((link) => {
      link.addEventListener('click', (e) => {
        const currentLink = e.currentTarget as HTMLElement;
        const container = currentLink.closest('.mega-menu-container');

        if (container) {
          // 锁定当前链接高亮
          currentLink.classList.add('link-clicked');
          // 强制隐藏菜单
          container.classList.add('force-close');
        }
      });
    });
  };

  document.addEventListener('astro:page-load', initMegaMenu);
</script>
